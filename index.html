<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Validador de Manifiestos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{--primary:#2b6cb0;--muted:#94a3b8;--card:#fff;--bg:#f7fafc}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#1a202c;margin:0;padding:18px}
    .container{max-width:1100px;margin:0 auto}
    header{position:relative;padding:1rem 1rem 1.5rem;display:flex;align-items:flex-start;gap:1rem}
    .title-block{flex:1}
    #topRightLogo{position:absolute;top:12px;right:12px;max-height:96px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.12);background:#fff;padding:4px;display:none}
    .logo-controls{position:absolute;top:12px;right:calc(12px + 100px);display:flex;gap:0.5rem}
    .logo-btn{background:#fff;border:1px solid #ddd;padding:6px 8px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .card{background:var(--card);border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .card-header h3{margin:0;display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:6px;border:0;background:var(--primary);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{background:transparent;border:1px solid #cbd5e1;color:#2d3748;padding:8px 12px;border-radius:6px;cursor:pointer}
    .data-label{display:block;font-weight:600}
    .data-value{display:block;padding:8px 10px;background:#f7fafc;border-radius:6px;margin-top:6px;white-space:pre-wrap}

    /* Instructions toggle */
    .instructions-card{border-radius:8px;padding:0;overflow:visible}
    .instructions-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--primary);color:#fff;border-radius:8px 8px 0 0}
    .toggle-btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.12);color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .instructions-wrapper{background:#e6f2ff;border-left:6px solid var(--primary);padding:14px;transition:max-height .26s ease,padding .26s ease;overflow:hidden;max-height:600px}
    .instructions-wrapper.collapsed{max-height:0;padding-top:0;padding-bottom:0}
    .instructions ol{margin:0 0 8px 18px}
    .instructions .important{background:#fff6d8;padding:8px;border-radius:6px;margin-top:10px}

    /* layout small */
    @media(max-width:720px){header{flex-direction:column} .logo-controls{position:static;margin-top:.5rem} #topRightLogo{position:static;max-height:56px}}

  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <div class="title-block">
        <h1 style="margin:0"><i class="bi bi-file-earmark-medical"></i> Validador de Manifiestos</h1>
        <p style="margin:6px 0 0;color:#4a5568">Escanea manifiestos y detecta automáticamente si son aceptables según tu lista maestra</p>
      </div>

      <div class="logo-controls" aria-hidden="false">
        <label for="logoInput" class="logo-btn" title="Cargar logo">
          <i class="bi bi-upload"></i><span class="logo-text">Cargar logo</span>
        </label>
        <button id="removeLogoBtn" class="logo-btn" title="Eliminar logo"><i class="bi bi-trash"></i><span class="logo-text">Eliminar</span></button>
        <input id="logoInput" type="file" accept="image/*" style="display:none">
      </div>

      <img id="topRightLogo" src="" alt="Logo">
    </header>

    <!-- <<--- INSTRUCCIONES: AQUI, justo al inicio, visible/expandido por defecto --->> -->
    <div class="card instructions-card" id="instructionsCard">
      <div class="instructions-header" role="heading" aria-level="3">
        <h3><i class="bi bi-info-circle"></i> ¿Cómo funciona el sistema?</h3>
        <button id="toggleInstructionsBtn" class="toggle-btn" aria-expanded="true" aria-controls="instructionsWrapper">
          <span id="toggleIcon"><i class="bi bi-chevron-up"></i></span>
          <span id="toggleText">Ocultar</span>
        </button>
      </div>
      <div id="instructionsWrapper" class="instructions-wrapper" aria-hidden="false">
        <div class="instructions" style="background:transparent;border-left:none;padding:0">
          <ol>
            <li><strong>Capture o suba</strong> una imagen del manifiesto de residuos.</li>
            <li>El sistema <strong>extrae automáticamente</strong> la información del manifiesto.</li>
            <li>Determina si es <strong>Aceptable o Rechazado</strong> según tus criterios.</li>
            <li>Si es Rechazado, puede <strong>levantar una incidencia</strong> con reporte descargable.</li>
          </ol>
          <div class="important"><strong>Nota importante:</strong> El proceso del sistema solo admite imagen PNG, JPEG o JPG.</div>
        </div>
      </div>
    </div>
    <!-- END INSTRUCCIONES -->

    <!-- PASO 1: Capturar -->
    <div class="card">
      <div class="card-header"><h3><i class="bi bi-camera"></i> Paso 1: Capturar Manifiesto</h3></div>
      <div class="card-body">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="cameraBtn" class="btn"><i class="bi bi-camera"></i> Usar Cámara</button>
          <button id="uploadBtn" class="btn"><i class="bi bi-upload"></i> Subir Imagen</button>
          <input id="fileInput" type="file" accept="image/*" hidden>
          <button id="processBtn" class="btn" disabled style="background:#8b5cf6"><i class="bi bi-magic"></i> Analizar Manifiesto</button>
        </div>

        <div id="imagePreview" style="display:flex;align-items:center;justify-content:center;min-height:220px;border:2px dashed #cbd5e1;border-radius:6px;background:#fff;margin-top:12px">
          <div style="text-align:center;color:#94a3b8"><p><i class="bi bi-image" style="font-size:3rem"></i></p><p>No hay imagen seleccionada</p></div>
        </div>

        <div id="cameraView" style="display:none;margin-top:12px">
          <video id="cameraStream" autoplay playsinline style="width:100%;max-height:360px;background:#000"></video>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="captureBtn" class="btn" style="background:#2f855a">Capturar</button>
            <button id="cancelCameraBtn" class="btn btn-outline">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results card (hidden until analysis) -->
    <div class="card results-card" style="display:none">
      <div class="card-header"><h3><i class="bi bi-clipboard-check"></i> Resultado del Análisis</h3></div>
      <div class="card-body">
        <div id="resultStatus"></div>
        <div style="margin-top:12px">
          <h4><i class="bi bi-card-checklist"></i> Datos Identificados del Manifiesto</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><span class="data-label">Razón Social (Generador):</span><div id="detectedCompany" class="data-value">No identificado</div></div>
            <div><span class="data-label">Descripción del Residuo:</span><div id="detectedWaste" class="data-value">No identificado</div></div>
          </div>
        </div>

        <div id="verificationDetails" style="margin-top:12px">
          <h4><i class="bi bi-search"></i> Detalles de la Verificación</h4>
          <div id="verificationContent"></div>
        </div>

        <div id="incidenceSection" style="display:none;margin-top:12px">
          <h4><i class="bi bi-exclamation-triangle"></i> Gestión de Incidencia</h4>
          <p>Este manifiesto ha sido <strong>rechazado</strong>. Registre la incidencia para seguimiento.</p>
          <textarea id="incidenceNotes" rows="3" style="width:100%"></textarea>
          <input id="assignedTo" placeholder="Asignar a (Responsable)" style="width:100%;margin-top:8px"/>
          <div style="margin-top:8px"><button id="registerIncidenceBtn" class="btn" style="background:#e53e3e">Registrar Incidencia</button> <button id="skipIncidenceBtn" class="btn btn-outline">Omitir</button></div>
        </div>

        <div style="margin-top:12px">
          <button id="newScanBtn" class="btn">Nuevo Escaneo</button>
          <button id="downloadReportBtn" class="btn btn-outline">Descargar Reporte</button>
        </div>
      </div>
    </div>

    <footer style="margin-top:18px"><p style="color:#718096">Sistema de Validación de Manifiestos v2.0 | <span id="versionInfo">Modo: Validación Automática</span></p></footer>
  </div>

  <!-- Tesseract -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <!-- Logo handling (localStorage) -->
  <script>
    (function(){
      const logoInput = document.getElementById('logoInput');
      const topRightLogo = document.getElementById('topRightLogo');
      const removeLogoBtn = document.getElementById('removeLogoBtn');
      const STORAGE_KEY = 'topRightLogoDataUrl_v1';
      const placeholderSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="320" height="96" viewBox="0 0 320 96"><rect width="100%" height="100%" rx="8" ry="8" fill="%23ffffff" stroke="%23e6e6e6"/><g transform="translate(16,12)"><rect x="0" y="0" width="80" height="72" rx="6" fill="%23f5f5f7" stroke="%23e0e0e0"/><text x="40" y="42" font-family="Arial" font-size="14" fill="%23b0b0b0" text-anchor="middle">LOGO</text></g><text x="110" y="56" font-family="Arial" font-size="14" fill="%23b0b0b0">Cargar tu logo aquí</text></svg>';
      const PLACEHOLDER_DATA_URL = 'data:image/svg+xml;utf8,'+encodeURIComponent(placeholderSvg);

      function loadLogo(){
        try {
          const dataUrl = localStorage.getItem(STORAGE_KEY);
          topRightLogo.src = dataUrl || PLACEHOLDER_DATA_URL;
          topRightLogo.style.display = 'block';
        } catch(e){
          topRightLogo.src = PLACEHOLDER_DATA_URL; topRightLogo.style.display='block';
        }
      }
      logoInput && logoInput.addEventListener('change', e=>{
        const file = e.target.files && e.target.files[0]; if(!file) return;
        if(!file.type.startsWith('image/')){ alert('Seleccione una imagen.'); return; }
        const reader = new FileReader(); reader.onload = ev=>{
          try{ localStorage.setItem(STORAGE_KEY, ev.target.result);}catch(e){}
          topRightLogo.src = ev.target.result; topRightLogo.style.display='block';
        }; reader.readAsDataURL(file);
      });
      removeLogoBtn && removeLogoBtn.addEventListener('click', ()=>{
        if(!confirm('¿Eliminar el logo actual?')) return;
        try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
        topRightLogo.src = PLACEHOLDER_DATA_URL; topRightLogo.style.display='block';
      });
      loadLogo();
    })();
  </script>

  <!-- Toggle script: start EXPANDED (if no saved preference, expanded) -->
  <script>
    (function(){
      const toggleBtn = document.getElementById('toggleInstructionsBtn');
      const wrapper = document.getElementById('instructionsWrapper');
      const toggleIcon = document.getElementById('toggleIcon');
      const toggleText = document.getElementById('toggleText');
      const STORAGE_KEY = 'instructionsCollapsed_v1';

      // If user has a saved preference, use it; otherwise default to expanded
      const saved = localStorage.getItem(STORAGE_KEY);
      const collapsed = saved === 'true';
      if (collapsed) {
        wrapper.classList.add('collapsed');
        wrapper.setAttribute('aria-hidden','true');
        toggleBtn.setAttribute('aria-expanded','false');
        toggleIcon.innerHTML = '<i class="bi bi-chevron-down"></i>';
        toggleText.textContent = 'Mostrar';
      } else {
        wrapper.classList.remove('collapsed');
        wrapper.setAttribute('aria-hidden','false');
        toggleBtn.setAttribute('aria-expanded','true');
        toggleIcon.innerHTML = '<i class="bi bi-chevron-up"></i>';
        toggleText.textContent = 'Ocultar';
      }

      toggleBtn && toggleBtn.addEventListener('click', function(){
        const isCollapsed = wrapper.classList.toggle('collapsed');
        if (isCollapsed) {
          wrapper.setAttribute('aria-hidden','true');
          toggleBtn.setAttribute('aria-expanded','false');
          toggleIcon.innerHTML = '<i class="bi bi-chevron-down"></i>';
          toggleText.textContent = 'Mostrar';
          localStorage.setItem(STORAGE_KEY, 'true');
        } else {
          wrapper.setAttribute('aria-hidden','false');
          toggleBtn.setAttribute('aria-expanded','true');
          toggleIcon.innerHTML = '<i class="bi bi-chevron-up"></i>';
          toggleText.textContent = 'Ocultar';
          localStorage.setItem(STORAGE_KEY, 'false');
          wrapper.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    })();
  </script>

  <!-- Enlace a tu script principal -->
  <script src="script.js"></script>
</body>
</html>
