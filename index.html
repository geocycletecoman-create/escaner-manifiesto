<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc치ner de Manifiestos - Clasificador Autom치tico</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游늶</text></svg>">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        /* Estilos m칤nimos para posicionar la imagen en la esquina superior derecha */
        header {
            position: relative;
            padding: 1rem 1rem 1.5rem 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        header .title-block {
            flex: 1;
        }

        #topRightLogo {
            position: absolute;
            top: 12px;
            right: 12px;
            max-height: 96px;
            width: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
            background: white;
            padding: 4px;
            object-fit: contain;
            transition: opacity 200ms ease, transform 160ms ease;
        }

        /* Placeholder visual: cuando no hay logo real se muestra un estilo m치s tenue */
        #topRightLogo.placeholder {
            opacity: 0.7;
            filter: grayscale(30%);
            transform: scale(1);
        }

        /* Controles para cambiar/eliminar logo */
        .logo-controls {
            position: absolute;
            top: 12px;
            right: calc(12px + 100px); /* desplazar a la izquierda del logo */
            display: flex;
            gap: 0.5rem;
            align-items: center;
            transition: width 240ms ease;
        }
        .logo-btn {
            background: rgba(255,255,255,0.95);
            border: 1px solid #ddd;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .logo-btn:active { transform: translateY(1px); }

        /* Usamos .logo-text para ser m치s precisos: solo esos spans se ocultar치n */
        .logo-controls .logo-text {
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            vertical-align: middle;
            transition: opacity 200ms ease, width 200ms ease, margin 200ms ease, padding 200ms ease;
            opacity: 1;
            width: auto;
        }

        /* Estado cuando hay logo: el texto se oculta (opacidad 0 y ancho 0) */
        .logo-controls.has-logo .logo-text {
            opacity: 0;
            width: 0;
            margin: 0;
            padding: 0;
            pointer-events: none; /* evita foco por accidente */
        }

        /* Peque침o ajuste visual para que los iconos queden bien centrados cuando los textos est치n ocultos */
        .logo-controls .bi {
            font-size: 1.05rem;
            line-height: 1;
        }

        /* Responsive: en pantallas peque침as movemos el logo al final del header y lo hacemos m치s peque침o */
        @media (max-width: 600px) {
            #topRightLogo {
                position: static;
                max-height: 56px;
                margin-left: 0;
                margin-top: 0.5rem;
                float: none;
            }
            .logo-controls {
                position: static;
                margin-top: 0.5rem;
                right: auto;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Ajustes opcionales para que el header no tape contenido con la imagen absoluta */
        .container {
            padding-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="title-block">
                <h1><i class="bi bi-file-earmark-medical"></i> Validador de Manifiestos</h1>
                <p class="subtitle">Escanea manifiestos y detecta autom치ticamente si son aceptables seg칰n tu lista maestra</p>
            </div>

            <!-- Controles para cargar/eliminar logo desde el ordenador -->
            <div class="logo-controls" aria-hidden="false">
                <label for="logoInput" class="logo-btn" title="Cargar logo desde tu ordenador" role="button">
                    <i class="bi bi-upload"></i>
                    <span class="logo-text">Cargar logo</span>
                </label>
                <button id="removeLogoBtn" class="logo-btn" title="Eliminar logo (volver al predeterminado)">
                    <i class="bi bi-trash"></i>
                    <span class="logo-text">Eliminar</span>
                </button>
                <!-- Input oculto para seleccionar archivo -->
                <input id="logoInput" type="file" accept="image/*" style="display:none">
            </div>

            <!-- Imagen en la esquina superior derecha.
                 Si no hay logo cargado, se mostrar치 el placeholder incluido en el script. -->
            <img id="topRightLogo" src="" alt="Logo" style="display:none">
        </header>

        <!-- PASO 1: CAPTURAR DOCUMENTO -->
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-camera"></i> Paso 1: Capturar Manifiesto</h3>
            </div>
            <div class="card-body">
                <div class="upload-options">
                    <button id="cameraBtn" class="btn btn-primary">
                        <i class="bi bi-camera"></i> Usar C치mara
                    </button>
                    <button id="uploadBtn" class="btn btn-secondary">
                        <i class="bi bi-upload"></i> Subir Imagen
                    </button>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" hidden>
                </div>

                <div class="preview-container">
                    <div id="imagePreview" class="image-preview">
                        <p><i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i></p>
                        <p>No hay imagen seleccionada</p>
                    </div>
                    <div id="cameraView" class="camera-view" style="display: none;">
                        <video id="cameraStream" autoplay playsinline></video>
                        <div class="camera-controls">
                            <button id="captureBtn" class="btn btn-success">
                                <i class="bi bi-camera-fill"></i> Capturar
                            </button>
                            <button id="cancelCameraBtn" class="btn btn-danger">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="process-button-container">
                    <button id="processBtn" class="btn btn-process" disabled>
                        <i class="bi bi-magic"></i> Analizar Manifiesto
                    </button>
                </div>
            </div>
        </div>

        <!-- PASO 2: PROCESAMIENTO (OCULTO INICIALMENTE) -->
        <div class="card processing-card" style="display: none;">
            <div class="card-header">
                <h3><i class="bi bi-hourglass-split"></i> Procesando...</h3>
            </div>
            <div class="card-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <p id="progressText">Iniciando an치lisis del manifiesto...</p>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <p class="processing-detail">Extrayendo datos con OCR...</p>
                </div>
            </div>
        </div>

        <!-- PASO 3: RESULTADOS DEL AN츼LISIS -->
        <div class="card results-card" style="display: none;">
            <div class="card-header">
                <h3><i class="bi bi-clipboard-check"></i> Resultado del An치lisis</h3>
            </div>
            <div class="card-body">
                
                <!-- VEREDICTO PRINCIPAL -->
                <div id="resultStatus" class="result-status">
                    <!-- Se llena autom치ticamente -->
                </div>
                
                <!-- DATOS EXTRA칈DOS DEL MANIFIESTO -->
                <div class="extracted-data">
                    <h4><i class="bi bi-card-checklist"></i> Datos Identificados del Manifiesto</h4>
                    <div class="data-grid">
                        <div class="data-item">
                            <span class="data-label">Raz칩n Social (Generador):</span>
                            <span id="detectedCompany" class="data-value">No identificado</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Descripci칩n del Residuo:</span>
                            <span id="detectedWaste" class="data-value">No identificado</span>
                        </div>
                    </div>
                </div>
                
                <!-- DETALLES DE LA VERIFICACI칍N -->
                <div id="verificationDetails" class="verification-details">
                    <h4><i class="bi bi-search"></i> Detalles de la Verificaci칩n</h4>
                    <div id="verificationContent">
                        <!-- Se llena din치micamente -->
                    </div>
                </div>
                
                <!-- SECCI칍N DE INCIDENCIA (SOLO SI ES RECHAZADO) -->
                <div id="incidenceSection" class="incidence-section" style="display: none;">
                    <h4><i class="bi bi-exclamation-triangle"></i> Gesti칩n de Incidencia</h4>
                    <p class="incidence-info">Este manifiesto ha sido <strong>rechazado</strong>. Por favor, registre la incidencia para seguimiento.</p>
                    
                    <div class="incidence-form">
                        <div class="form-group">
                            <label for="incidenceNotes">Observaciones de la Incidencia *</label>
                            <textarea id="incidenceNotes" class="form-control" rows="3" placeholder="Describa los motivos del rechazo y cualquier observaci칩n relevante..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="assignedTo">Asignar a (Responsable):</label>
                            <input type="text" id="assignedTo" class="form-control" placeholder="Ej: Departamento Ambiental, Supervisor">
                        </div>
                        <div class="form-action-buttons">
                            <button id="registerIncidenceBtn" class="btn btn-danger">
                                <i class="bi bi-flag-fill"></i> Registrar Incidencia
                            </button>
                            <button id="skipIncidenceBtn" class="btn btn-outline">
                                Omitir por ahora
                            </button>
                        </div>
                    </div>
                    
                    <div id="incidenceConfirmation" class="incidence-confirmation" style="display: none;">
                        <div class="confirmation-content">
                            <i class="bi bi-check-circle-fill success-icon"></i>
                            <h5>Incidencia Registrada Exitosamente</h5>
                            <p id="confirmationMessage">La incidencia <strong>INC-001</strong> ha sido registrada en el sistema.</p>
                            <div class="confirmation-actions">
                                <button id="downloadIncidenceReport" class="btn btn-success">
                                    <i class="bi bi-download"></i> Descargar Reporte
                                </button>
                                <button id="newScanAfterIncidence" class="btn btn-outline">
                                    <i class="bi bi-plus-circle"></i> Nuevo Escaneo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ACCIONES FINALES -->
                <div class="final-actions">
                    <button id="newScanBtn" class="btn btn-primary">
                        <i class="bi bi-arrow-repeat"></i> Nuevo Escaneo
                    </button>
                    <button id="downloadReportBtn" class="btn btn-outline">
                        <i class="bi bi-file-earmark-text"></i> Descargar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- INFORMACI칍N DEL SISTEMA -->
        <div class="instructions">
            <h4><i class="bi bi-info-circle"></i> 쮺칩mo funciona el sistema?</h4>
            <ol>
                <li><strong>Capture o suba</strong> una imagen del manifiesto de residuos</li>
                <li>El sistema <strong>extrae autom치ticamente</strong> la informaci칩n del manifiesto</li>
                <li>Determina si es <strong>Aceptable o Rechazado</strong> seg칰n tus criterios</li>
                <li>Si es Rechazado, puede <strong>levantar una incidencia</strong> con reporte descargable</li>
            </ol>
            <div class="note">
                <strong>Nota importante:</strong> El proceso del sistema solo admite imagen PNG,JPEG o JPG. 
            </div>
        </div>

        <footer>
            <p>Sistema de Validaci칩n de Manifiestos v2.0 | 
                <span id="versionInfo">Modo: Validaci칩n Autom치tica</span>
            </p>
        </footer>
    </div>

    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js'></script>

    <!-- Script para gestionar la carga del logo desde el ordenador y persistir en localStorage (versi칩n con placeholder) -->
    <script>
        (function () {
            const logoInput = document.getElementById('logoInput');
            const topRightLogo = document.getElementById('topRightLogo');
            const removeLogoBtn = document.getElementById('removeLogoBtn');
            const logoControls = document.querySelector('.logo-controls');
            const STORAGE_KEY = 'topRightLogoDataUrl_v1';

            // SVG simple usado como placeholder (se codifica en runtime)
            const placeholderSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="320" height="96" viewBox="0 0 320 96"><rect width="100%" height="100%" rx="8" ry="8" fill="%23ffffff" stroke="%23e6e6e6"/><g transform="translate(16,12)"><rect x="0" y="0" width="80" height="72" rx="6" fill="%23f5f5f7" stroke="%23e0e0e0"/><text x="40" y="42" font-family="Arial, Helvetica, sans-serif" font-size="14" fill="%23b0b0b0" text-anchor="middle">LOGO</text></g><text x="110" y="56" font-family="Arial, Helvetica, sans-serif" font-size="14" fill="%23b0b0b0">Cargar tu logo aqu칤</text></svg>';
            const PLACEHOLDER_DATA_URL = 'data:image/svg+xml;utf8,' + encodeURIComponent(placeholderSvg);

            function setHasLogoClass(has) {
                if (!logoControls) return;
                if (has) logoControls.classList.add('has-logo');
                else logoControls.classList.remove('has-logo');
            }

            function setPlaceholderClass(isPlaceholder) {
                if (!topRightLogo) return;
                if (isPlaceholder) topRightLogo.classList.add('placeholder');
                else topRightLogo.classList.remove('placeholder');
            }

            // Cargar logo desde localStorage si existe; si no existe, usar placeholder
            function loadLogoFromStorage() {
                try {
                    const dataUrl = localStorage.getItem(STORAGE_KEY);
                    if (dataUrl) {
                        topRightLogo.src = dataUrl;
                        setHasLogoClass(true);
                        setPlaceholderClass(false);
                    } else {
                        topRightLogo.src = PLACEHOLDER_DATA_URL;
                        setHasLogoClass(false);
                        setPlaceholderClass(true);
                    }
                    topRightLogo.style.display = 'block';
                } catch (e) {
                    // Si localStorage falla, mostramos placeholder
                    topRightLogo.src = PLACEHOLDER_DATA_URL;
                    topRightLogo.style.display = 'block';
                    setHasLogoClass(false);
                    setPlaceholderClass(true);
                    console.warn('No se pudo acceder a localStorage:', e);
                }
            }

            // Manejar archivo seleccionado
            logoInput.addEventListener('change', function (ev) {
                const file = ev.target.files && ev.target.files[0];
                if (!file) return;

                // Validaciones b치sicas
                if (!file.type.startsWith('image/')) {
                    alert('Por favor selecciona un archivo de imagen (png, jpg, jpeg, webp, ...).');
                    logoInput.value = '';
                    return;
                }
                const maxSizeMB = 4;
                if (file.size > maxSizeMB * 1024 * 1024) {
                    alert('El archivo es demasiado grande. Tama침o m치ximo recomendado: ' + maxSizeMB + ' MB.');
                    logoInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const dataUrl = e.target.result;
                    topRightLogo.src = dataUrl;
                    topRightLogo.style.display = 'block';
                    setHasLogoClass(true);
                    setPlaceholderClass(false);

                    // Persistir en localStorage para que el logo permanezca entre recargas
                    try {
                        localStorage.setItem(STORAGE_KEY, dataUrl);
                    } catch (err) {
                        console.warn('No fue posible guardar el logo en localStorage:', err);
                    }
                };
                reader.readAsDataURL(file);
            });

            // Click en eliminar logo
            removeLogoBtn.addEventListener('click', function () {
                if (!confirm('쮼liminar el logo actual? Esto lo quitar치 de la vista y no se restaurar치 autom치ticamente.')) return;

                // Borrar storage y restaurar placeholder
                try {
                    localStorage.removeItem(STORAGE_KEY);
                } catch (e) {
                    console.warn('No se pudo eliminar logo de localStorage:', e);
                }

                topRightLogo.src = PLACEHOLDER_DATA_URL;
                topRightLogo.style.display = 'block';
                setHasLogoClass(false);
                setPlaceholderClass(true);
                logoInput.value = '';
            });

            // Inicializar al cargar la p치gina
            loadLogoFromStorage();

            // Opcional: permitir cambiar logo haciendo clic en la imagen
            // topRightLogo.addEventListener('click', () => logoInput.click());
        })();
    </script>

    <!-- Tu script principal de la app (si existe) -->
    <script src="script.js"></script>
</body>
</html>
