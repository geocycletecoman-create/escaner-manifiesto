<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc치ner de Manifiestos - Clasificador Autom치tico</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游늶</text></svg>">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
      /* Peque침os ajustes para mostrar el icono de la aplicaci칩n */
      #topAppIcon {
        width:44px;
        height:44px;
        border-radius:8px;
        margin-right:10px;
        vertical-align:middle;
      }
      header {
        display:flex;
        align-items:center;
        gap:12px;
      }
      /* Report template (hidden) */
      .pdf-report-template {
        font-family: Arial, Helvetica, sans-serif;
        padding:20px;
        color:#111;
        width:800px;
        background:#fff;
      }
      .pdf-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
      .pdf-logo { width:64px; height:64px; border-radius:8px; }
      .pdf-title { font-size:20px; font-weight:700; }
      .pdf-section { margin-top:10px; }
      .pdf-kv { display:flex; gap:8px; margin:4px 0; }
      .pdf-kv .k { width:180px; font-weight:700; color:#333; }
      .pdf-kv .v { color:#222; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <!-- ICONO EN LA PARTE SUPERIOR: reemplaza src por tu logo si deseas -->
            <img id="topAppIcon" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='16' width='100' height='100' fill='%23348' /><text x='50' y='58' font-size='48' text-anchor='middle' fill='white' font-family='Arial'>G</text></svg>" alt="App">
            <div>
              <h1 style="margin:0;"><i class="bi bi-file-earmark-medical"></i> Validaci칩n Autom치tica</h1>
              <p class="subtitle" style="margin:0.2rem 0 0 0;">Escanea manifiestos y detecta autom치ticamente si son aceptables seg칰n perfiles CRM</p>
            </div>
        </header>

        <!-- PASO 1: CAPTURAR DOCUMENTO -->
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-camera"></i> Paso 1: Capturar Manifiesto</h3>
            </div>
            <div class="card-body">
                <div class="upload-options">
                    <button id="cameraBtn" class="btn btn-primary">
                        <i class="bi bi-camera"></i> Usar C치mara
                    </button>
                    <button id="uploadBtn" class="btn btn-secondary">
                        <i class="bi bi-upload"></i> Subir Imagen
                    </button>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" hidden>
                </div>

                <div class="preview-container">
                    <div id="imagePreview" class="image-preview">
                        <p><i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i></p>
                        <p>No hay imagen seleccionada</p>
                    </div>
                    <div id="cameraView" class="camera-view" style="display: none;">
                        <video id="cameraStream" autoplay playsinline></video>
                        <div class="camera-controls">
                            <button id="captureBtn" class="btn btn-success">
                                <i class="bi bi-camera-fill"></i> Capturar
                            </button>
                            <button id="cancelCameraBtn" class="btn btn-danger">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="process-button-container">
                    <button id="processBtn" class="btn btn-process" disabled>
                        <i class="bi bi-magic"></i> Analizar Manifiesto
                    </button>
                </div>
            </div>
        </div>

        <!-- PASO 2: PROCESAMIENTO (OCULTO INICIALMENTE) -->
        <div class="card processing-card" style="display: none;">
            <div class="card-header">
                <h3><i class="bi bi-hourglass-split"></i> Procesando...</h3>
            </div>
            <div class="card-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <p id="progressText">Iniciando an치lisis del manifiesto...</p>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <p class="processing-detail">Extrayendo datos con OCR...</p>
                </div>
            </div>
        </div>

        <!-- PASO 3: RESULTADOS DEL AN츼LISIS -->
        <div class="card results-card" style="display: none;">
            <div class="card-header">
                <h3><i class="bi bi-clipboard-check"></i> Resultado del An치lisis</h3>
            </div>
            <div class="card-body">
                
                <!-- VEREDICTO PRINCIPAL -->
                <div id="resultStatus" class="result-status">
                    <!-- Se llena autom치ticamente -->
                </div>
                
                <!-- DATOS EXTRA칈DOS DEL MANIFIESTO -->
                <div class="extracted-data">
                    <h4><i class="bi bi-card-checklist"></i> Datos Identificados del Manifiesto</h4>
                    <div class="data-grid">
                        <div class="data-item">
                            <span class="data-label">Raz칩n Social (Generador):</span>
                            <span id="detectedCompany" class="data-value">No identificado</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Descripci칩n del Residuo:</span>
                            <span id="detectedWaste" class="data-value">No identificado</span>
                        </div>
                    </div>
                </div>
                
                <!-- DETALLES DE LA VERIFICACI칍N -->
                <div id="verificationDetails" class="verification-details">
                    <h4><i class="bi bi-search"></i> Detalles de la Verificaci칩n</h4>
                    <div id="verificationContent">
                        <!-- Se llena din치micamente -->
                    </div>
                </div>
                
                <!-- SECCI칍N DE INCIDENCIA (SOLO SI ES RECHAZADO) -->
                <div id="incidenceSection" class="incidence-section" style="display: none;">
                    <h4><i class="bi bi-exclamation-triangle"></i> Gesti칩n de Incidencia</h4>
                    <p class="incidence-info">Este manifiesto ha sido <strong>rechazado</strong>. Por favor, registre la incidencia para seguimiento.</p>
                    
                    <div class="incidence-form">
                        <div class="form-group">
                            <label for="incidenceNotes">Observaciones de la Incidencia *</label>
                            <textarea id="incidenceNotes" class="form-control" rows="3" placeholder="Describa los motivos del rechazo y cualquier observaci칩n relevante..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="assignedTo">Asignar a (Responsable):</label>
                            <input type="text" id="assignedTo" class="form-control" placeholder="Ej: Departamento Ambiental, Supervisor">
                        </div>
                        <div class="form-action-buttons">
                            <button id="registerIncidenceBtn" class="btn btn-danger">
                                <i class="bi bi-flag-fill"></i> Registrar Incidencia
                            </button>
                            <button id="skipIncidenceBtn" class="btn btn-outline">
                                Omitir por ahora
                            </button>
                        </div>
                    </div>
                    
                    <div id="incidenceConfirmation" class="incidence-confirmation" style="display: none;">
                        <div class="confirmation-content">
                            <i class="bi bi-check-circle-fill success-icon"></i>
                            <h5>Incidencia Registrada Exitosamente</h5>
                            <p id="confirmationMessage">La incidencia <strong>INC-001</strong> ha sido registrada en el sistema.</p>
                            <div class="confirmation-actions">
                                <button id="downloadIncidenceReport" class="btn btn-success">
                                    <i class="bi bi-download"></i> Descargar Reporte
                                </button>
                                <button id="newScanAfterIncidence" class="btn btn-outline">
                                    <i class="bi bi-plus-circle"></i> Nuevo Escaneo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ACCIONES FINALES -->
                <div class="final-actions">
                    <button id="newScanBtn" class="btn btn-primary">
                        <i class="bi bi-arrow-repeat"></i> Nuevo Escaneo
                    </button>
                    <button id="downloadReportBtn" class="btn btn-outline">
                        <i class="bi bi-file-earmark-text"></i> Descargar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- INFORMACI칍N DEL SISTEMA -->
        <div class="instructions">
            <h4><i class="bi bi-info-circle"></i> 쮺칩mo funciona el sistema?</h4>
            <ol>
                <li><strong>Capture o suba</strong> una imagen del manifiesto</li>
                <li>El sistema <strong>extrae autom치ticamente</strong> la informaci칩n del manifiesto</li>
                <li>Determina si es <strong>Aceptable o Rechazado</strong> seg칰n perfiles CRM</li>
                <li>Si es Rechazado, puede <strong>levantar una incidencia</strong> con reporte descargable</li>
            </ol>
            <div class="note">
                <strong>Nota importante:</strong> El proceso del sistema solo admite imagen PNG,JPEG o JPG. 
            </div>
        </div>

        <footer>
            <p>| Geocycle Tecoman Rethinking Waste |
                <span id="versionInfo">Modo: Version Beta</span>
            </p>
        </footer>
    </div>

    <!-- Librer칤as necesarias -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- Nuestro script mejorado -->
    <script src="script.js"></script>
</body>
</html>
